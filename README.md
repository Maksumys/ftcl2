# Описание библиотеки FTCL
##Обозначения
<div align=" justify ">**Time-запрос( time-сообщение )** - запрос на определенное время выполнения T, если в течении этого времени запрос не завершается, то запрос отменяется.

<div align=" justify ">**Перезагрузка узла** - перезагрузка worker или мастера с помощью инструмента ipmitool. Перезагрузка осуществляется не более одного раза.

<div align=" justify ">**Реинициализация воркера**<br>
1) пересоздание процесса worker в случае возврата кода ошибки из MPI функций( первая ошибка узла ).  
2) Перезагрузка узла в случае истечения времени ожидания окончания MPI функции или при повторном возврате кода ошибки из MPI функции.  
3) Перевод worker в состояние неактивного при возврате кода ошибки из MPI функции после перезагрузки узла.

##Схема работы
###1. Инициализация  
<div align=" justify ">
**Воркер**: шлет мастеру time-сообщение, в случае неуспеха аварийно завершается( MPI_Abort )  
<div align=" justify ">
**Мастер**: ждет инициализационных сообщений от воркеров. Воркер становится активным, если отправил сообщение мастеру. Проверка сообщения инициализации воркера без времени( на всю работу программы )  
Пересылка сообщений инициализации.</div>
![](/init.jpg)
<div align=" justify ">Один из воркеров не смог корректно отослать сообщение инициализации и остался неактивным.</div>
![](/init_with_fail.jpg)

###2. Получение имен воркеров(опционально?) 
- <div align=" justify ">
**Мастер**: шлет time-запрос на получение имени воркера. В случае ошибки передачи, реинициализация воркера. 
<div align=" justify ">
**Воркер**: ждет запрос от мастера. Если ошибка ожидания(возврат кода ошибки от IProbe).
</div>
	- <div align=" justify ">
**Воркер**: шлет time-сообщение мастеру. В случае неудачи смена мастера на запасного.
</div>
<div align=" justify ">
**Мастер**: принимает сообщение от worker'а. В случае неудачи реинициализация worker'а.</br>   
Отправка запросов на имена worker'ов. Один из запросов закончился с ошибкой.</div>
	![](workersName2.jpg)<br>
Делаем реинициализацию worker'а.  
![](https://cvws.icloud-content.com/B/ARlK7y1L8TvDaMCvaI4-liczXHPTAQj5G8jUGZQv2jHV90FU2ORQbD7j/getName3.jpg?o=AtZS7vOXXcaRtbZP9AoHeHndiInckfUKdnBtpdzNsFeC&v=1&x=3&a=B8DJbHELdWmkzHJReTQ3AzlO9HmyAzazQAEAAAMns0A&e=1516714866&k=XEfg9RhimBdWvETBg26w0g&fl=&r=049b9ae6-5590-42f5-a896-6d090514f0c1-1&ckc=com.apple.clouddocs&ckz=27N4MQEA55.pro.writer&p=30&s=vgJgljTyAgTS4Nlm8NZ7Fk9h6sw&cd=i)<br>
Для пересозданнаого worker'а переходим к пункту 1.
###3. Работа
###4. Завершение работы
- Мастер шлет time-запрос на завершение воркеру. В случае истечения времени - аварийное завершение через время T. В случае ошибки выполнения MPI функции - аварийное завершение.
- Ожидание ответа от воркера в течении времени T. Если ответа нет, то аварийное завершение.

В данный момент сделано:  
1. Класс NetworkModule - все операции передачи информации через сеть. Каждый метод защищен mutex’ом.  
2. Классы Logger - логирование действий в консоль и файл.  
3. Класс Master - мастер  
4. Класс Worker - воркер  
5. Класс Status - информация о воркерах, их состояние, все request и время работы неблокирующих операций MPI.  
6. Классы очередей 

Что надо сделать:   
1. Разобраться до конца с восстановлением состояния узлов  
2. Перезагрузка узлов  
3. Интерфейс задач  
4. Сериализация объектов - (пока думаю, сделать boost.serialization или что то свое)


[https://github.com/Maksumys/ftcl2](https://github.com/Maksumys/ftcl2)
